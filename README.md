

# GarmageJigsaw



<p align="center"><img src="assest/images/garmagejigsaw.png" width="100%"></p>

We introduce GarmageJigsaw, a dedicated module that leverages Garmageâ€™s embedded 2D silhouettes and 3D spatial cues to robustly infer vertex-wise sewing correspondences, followed by post-processing routines that yield production-ready, vector-format sewing patterns. 



## ğŸ”¨ Installation

**Tested Environment:** `Ubuntu 22.04` + `CUDA 11.8` + `Python 3.8` + `PyTorch 1.10`

Clone the repo.

Install PyTorch and other dependencies:

```bash
conda create -n garmagejigsaw python=3.8
pip install -r requirements.txt
conda install cudatoolkit=11.8
pip install chamferdist
```



## ğŸ¤– Data Process

Download dataset refer to the **Data Preparation** part in the **[GarmageNet](https://github.com/Style3D/garmagenet-impl)**.

Preprocess training data:

```bash
# Preprocess Garmageset raw objs.
python data_process/garmageset/preprocess_stylexd.py \
	--objs_dir <garmageset-root>/raw \
	--output_root <garmageset-root>/garmagejigsaw_data/preprocessed_jigsaw_train

# Prepare datalist
python data_process/garmageset/get_dataset_split.py \
	--dataset_dir <garmageset-root>/garmagejigsaw_data/preprocessed_jigsaw_train \
    --output_dir <garmageset-root>/garmagejigsaw_data/datalist
```



## ğŸ¡ GarmageJigsaw Training

Update the following lines in the config file: **experiments/train/train.yaml**

```yaml
DATA:
  DATA_DIR: "<garmageset-root>/garmagejigsaw_data/preprocessed_jigsaw_train"
  DATASET_SPLIT_DIR: "<garmageset-root>/garmagejigsaw_data/datalist"
```

Train GarmageJigsaw.

```bash
python garmage_jigsaw/train_garmage_jigsaw.py \
	--cfg experiments/train/train.yaml
```



## ğŸ­ Sewing Recovery (Inference)

### GarmageNet Output

The GarmageNet generate output like following (for example sketch condition generation):

```bash
<garmagenet-output-dir>
â””â”€â”€ sketch_cond
â”‚Â Â  â”œâ”€â”€ <uuid_1>.pkl				# garmage
â”‚Â Â  â”œâ”€â”€ <uuid_1>_geo_img.png		# visualize garmage as 2D image panel-wise
â”‚Â Â  â”œâ”€â”€ <uuid_1>_pointcloud.png		# visualize garmage in 3D
â”‚Â Â  â”œâ”€â”€ ...
â”‚Â Â  â”œâ”€â”€ <uuid_n>.pkl
â”‚Â Â  â”œâ”€â”€ <uuid_n>_geo_img.png
â”‚Â Â  â””â”€â”€ <uuid_n>_pointcloud.png
```

### Extract Boundary 

Extract boundary points and vectorized pattern of Garmage generated by GarmageNet.

```bash
python garmage_jigsaw/extract_boundary_pts.py \
    --data_dir <garmagenet-output-dir>/sketch_cond \
    --delta 0.012 \
    --shape_dedup False
```
The boundary extraction results like following.

```bash
<garmagenet-output-dir>
â””â”€â”€ sketch_cond_extracted
â”‚Â Â  â”œâ”€â”€ <uuid_1>
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ piece_1.obj		# boundary points of panel 1
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ...
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ piece_n.obj		# boundary points of panel n
â”‚Â Â  â”‚Â Â  â””â”€â”€ annotation
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ garment_<uuid_1>.json	# vectorized pattern (without sewing)
â”‚Â Â  â”œâ”€â”€ ...
â”‚Â Â  â”œâ”€â”€ <uuid_n>
```

<p align="center"><img src="assest/images/postprocess_extract_boundary.png" width="100%"></p>

### GarmageJigsaw Inference

Recovery point-wise sewing of Garmage, and merge it into vectorized pattern to get the sewing pattern.

```bash
python garmage_jigsaw/inference_ps2es.py \
    --cfg experiments/train/train.yaml \
    --weight <GarmageJigsaw-ckpt> \
    --data_dir <garmagenet-output-dir>/sketch_cond_extracted \
    --update_dis_iter 1 --inf_noise_strength 6
```

â€‹	*For high-quality generation results, `--delta` can be set to **0.008** and `--inf_noise_strength` can be set to **3**.*

The GarmageJigsaw outputs like following.

```bash
<garmagenet-output-dir>
â””â”€â”€ garmagejigsaw_output
â”‚Â Â  â”œâ”€â”€ <uuid_1>
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ garment.json		# vectorized sewing pattern
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ orig_data.pkl		# garmage
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ vis_comp.html		# visualization 
â”‚Â Â  â”‚Â Â  â””â”€â”€ vis_resource.pkl
â”‚Â Â  â”œâ”€â”€ ...
â”‚Â Â  â”œâ”€â”€ <uuid_n>
```

<p align="center"><img src="assest/images/postprocess_GarmageJigsaw_output.png" width="100%"></p>

## ğŸ‘• Integrating to [Style3D Studio](https://studio.style3d.com/)
GarmageJigsaw outputs a vectorized **sewing pattern** configuration stored in JSON format. 
After triangulating it and arranging it using the geometry in **Garmage**, a garment that supports physical simulation can be obtained.

### ğŸ¦¾Triangulation

**[Step 1]** Import the output of **GarmageJigsaw** into the **Style3D Studio** software and save it as a `.sproj` file *(Run in **Style3d Studio**)*.

You should copy the code of  **`garmage_jigsaw/post_processing/json_2_sproj.py`** to the Style3D Studio script window. 

Then change `data_root` to the `<garmagenet-output-dir>/garmagejigsaw_output` and run script by press the button shown in image below.

<p align="center"><img src="assest/images/postprocess_json_2_sproj.png" width=100%"></p>

------

**[Step 2]** Export the flattened triangulated patterns in `.obj` format from the `.sproj` file *(Run in **IDE**)*.

```bash
python garmage_jigsaw/post_processing/sproj_2_json_obj.py \
	--data_root <garmagenet-output-dir>/arrangement
```

<p align="center"><img src="assest/images/postprocess_sproj_2_json_obj.png" width=100%"></p>

### ğŸ¦¿Arrangement

**[Step 3]** Arrange the triangulated flattened patterns using the geometric information from generated **Garmage** *(Run in **IDE**)*.

```
python garmage_jigsaw/post_processing/arrangement.py \
	--data_dir <garmagenet-output-dir>/arrangement
```

<p align="center"><img src="assest/images/postprocess_arrangement.png" width=100%"></p>

------

**[Step 4]** Import the arranged triangulated pattern pieces together with the sewing pattern into the software. *(Run in **Style3d Studio**)*.

```
Copy the code of garmage_jigsaw/post_processing/arrangement_2_sproj.py to the Style3D Studio script window.
Change data_root in the code.
Run script in Style3D Studio.
```

You should copy the code of `**garmage_jigsaw/post_processing/arrangement_2_sproj.py**` to the Style3D Studio script window. 

Then change `data_root` to the `<garmagenet-output-dir>/arrangement` and run script by press the button shown in image below.

<p align="center"><img src="assest/images/postprocess_arrangement_2_sproj.png" width=100%"></p>
